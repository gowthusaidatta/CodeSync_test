<script>
  const query = new URLSearchParams(window.location.search);
  const leetcode = query.get("leetcode");
  const codechef = query.get("codechef");
  const hackerrank = query.get("hackerrank");
  const gfg = query.get("gfg");

  const lambdaURL = `https://8teu07es5h.execute-api.us-east-1.amazonaws.com/prob/get-score?${[
    leetcode ? `leetcode=${leetcode}` : '',
    codechef ? `codechef=${codechef}` : '',
    hackerrank ? `hackerrank=${hackerrank}` : ''
  ].filter(Boolean).join("&")}`;

  const gfgURL = gfg ? `https://1irslt4qe5.execute-api.us-east-1.amazonaws.com/prob/get-score?username=${gfg}` : null;

  const resultsDiv = document.getElementById("results");
  const loadingDiv = document.getElementById("loading");
  const errorDiv = document.getElementById("error");

  async function fetchResults() {
    try {
      const [lambdaRes, gfgRes] = await Promise.all([
        fetch(lambdaURL),
        gfgURL ? fetch(gfgURL) : Promise.resolve(null)
      ]);

      const lambdaData = await lambdaRes.json();
      const gfgData = gfgRes && gfgRes.ok ? await gfgRes.json() : null;

      resultsDiv.innerHTML = "";

      // LeetCode
      if (lambdaData.leetcode && !lambdaData.leetcode.error) {
        resultsDiv.innerHTML += renderCard("LeetCode", `
          <p><strong>${lambdaData.leetcode.username}</strong></p>
          <p>Total Solved: ${lambdaData.leetcode.total_problems_solved}</p>
          <p>Ranking: ${lambdaData.leetcode.ranking}</p>
          <p>Easy: ${lambdaData.leetcode.easy}, Medium: ${lambdaData.leetcode.medium}, Hard: ${lambdaData.leetcode.hard}</p>
        `);
      }

      // CodeChef
      if (lambdaData.codechef && !lambdaData.codechef.error) {
        resultsDiv.innerHTML += renderCard("CodeChef", `
          <p><strong>${lambdaData.codechef.username}</strong></p>
          <p>Solved: ${lambdaData.codechef.problems_solved}</p>
          <p>Rating: ${lambdaData.codechef.contest_rating}</p>
          <p>Contests: ${lambdaData.codechef.contests_participated}</p>
          <p>Stars: ${lambdaData.codechef.stars}</p>
        `);
      }

      // HackerRank
      if (lambdaData.hackerrank && !lambdaData.hackerrank.error) {
        resultsDiv.innerHTML += renderCard("HackerRank", `
          <p><strong>${lambdaData.hackerrank.username}</strong></p>
          <p>Badges: ${lambdaData.hackerrank.badges}</p>
        `);
      }

      // GeeksforGeeks
      if (gfgData && gfgData.username) {
        resultsDiv.innerHTML += renderCard("GeeksforGeeks", `
          <p><strong>${gfgData.fullName}</strong></p>
          <img src="${gfgData.profileImage}" alt="Profile" class="w-20 h-20 rounded-full mx-auto mb-2" />
          <p>Institute: ${gfgData.institute}</p>
          <p>Total Solved: ${gfgData.totalProblemsSolved}</p>
          <p>Streak ðŸ”¥: ${gfgData.currentStreak}</p>
          <p>Coding Score: ${gfgData.codingScore}</p>
          <p>Institute Rank: ${gfgData.instituteRank}</p>
          <p>Easy: ${gfgData.easyProblems}, Medium: ${gfgData.mediumProblems}, Hard: ${gfgData.hardProblems}</p>
        `);
      }

      resultsDiv.classList.remove("hidden");
      loadingDiv.classList.add("hidden");

    } catch (err) {
      console.error("Fetch error:", err);
      errorDiv.classList.remove("hidden");
      loadingDiv.classList.add("hidden");
    }
  }

  function renderCard(title, html) {
    return `
      <div class="bg-white/10 rounded-xl p-5 shadow-md">
        <h3 class="text-xl font-bold text-purple-400 mb-2">${title}</h3>
        <div class="text-sm space-y-1">${html}</div>
      </div>
    `;
  }

  fetchResults();
</script>
