<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CodeSync | Results</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col items-center justify-center">

  <div class="w-full max-w-xl p-6 bg-white rounded-lg shadow-md">
    <h1 class="text-3xl font-bold text-center text-blue-600 mb-6">📊 Coding Platform Scores</h1>

    <div class="grid grid-cols-2 gap-4 text-lg" id="scoreDisplay">
      <!-- Platform scores will be inserted here -->
    </div>
  </div>

  <!-- ✅ Amplify + Config -->
  <script src="https://cdn.jsdelivr.net/npm/aws-amplify@4.3.27/dist/aws-amplify.min.js"></script>
  <script src="./js/amplify_config.js"></script>

  <script>
    // ✅ Main session check + score fetch
    document.addEventListener("DOMContentLoaded", async () => {
      const { Auth } = window.aws_amplify;
      Auth.configure(window.amplifyConfig);

      try {
        // ✅ 1. Validate session (token persisted via localStorage)
        const session = await Auth.currentSession();
        const user = await Auth.currentAuthenticatedUser();
        const attributes = await Auth.userAttributes(user);

        // ✅ 2. Parse user attributes
        const attr = {};
        attributes.forEach(a => attr[a.Name] = a.Value);

        const leetcode = attr["custom:leetcode_username"];
        const codechef = attr["custom:codechef_username"];
        const hackerrank = attr["custom:hackerrank_username"];
        const gfg = attr["custom:gfg_username"];
        const fullname = attr["name"];

        console.log("✅ Logged in as:", attr["email"]);

        // ✅ 3. Fetch and display scores
        fetchScores(leetcode, codechef, hackerrank, gfg, fullname);

      } catch (err) {
        console.warn("❌ Session invalid or expired:", err);
        alert("Session expired. Please login again.");
        window.location.href = "index.html";
      }
    });

    // ✅ Score Fetcher
    async function fetchScores(leetcode, codechef, hackerrank, gfg, name) {
      try {
        const apiUrl = "https://8teu07es5h.execute-api.us-east-1.amazonaws.com/prob/get-score";
        const url = `${apiUrl}?leetcode=${leetcode}&codechef=${codechef}&hackerrank=${hackerrank}&gfg=${gfg}&name=${encodeURIComponent(name)}`;

        const res = await fetch(url);
        const data = await res.json();

        const scoreHTML = `
          <div>👤 Name:</div><div>${name}</div>
          <div>💻 LeetCode:</div><div>${data.leetcode?.score || 0}</div>
          <div>🥘 CodeChef:</div><div>${data.codechef?.score || 0}</div>
          <div>🏅 HackerRank:</div><div>${data.hackerrank?.score || 0}</div>
          <div>📚 GFG:</div><div>${data.gfg?.score || 0}</div>
        `;

        document.getElementById("scoreDisplay").innerHTML = scoreHTML;

      } catch (err) {
        console.error("❌ Error fetching scores:", err);
        document.getElementById("scoreDisplay").innerHTML = "<div class='col-span-2 text-red-600'>Failed to load scores.</div>";
      }
    }
  </script>
</body>
</html>
